<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Cover Designer</title>
    <script src="node_modules/konva/konva.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        .editor-container { display: flex; height: 100vh; }
        
        .toolbar {
            width: 280px;
            background: #2d2d2d;
            border-right: 1px solid #444;
            display: flex;
            flex-direction: column;
        }
        
        .canvas-area {
            flex: 1;
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .canvas-wrapper {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .tool-group {
            padding: 15px;
            border-bottom: 1px solid #444;
        }
        
        .tool-group h3 {
            font-size: 12px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        
        .tool-btn {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: #3a3a3a;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .tool-btn:hover { background: #4a4a4a; }
        .tool-btn.active { background: #007acc; }
        
        .property-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .property-label {
            font-size: 11px;
            color: #ccc;
            width: 80px;
            text-transform: uppercase;
        }
        
        .property-input {
            flex: 1;
            padding: 6px 8px;
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 4px;
            color: white;
            font-size: 12px;
        }
        
        .color-input {
            width: 40px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .range-input {
            flex: 1;
            margin: 0 8px;
        }
        
        .layers-panel {
            flex: 1;
            overflow-y: auto;
        }
        
        .layer-item {
            padding: 8px 15px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .layer-item:hover { background: #333; }
        .layer-item.selected { background: #007acc; }
        
        .layer-controls {
            display: flex;
            gap: 5px;
        }
        
        .layer-btn {
            width: 20px;
            height: 20px;
            background: #555;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
            font-size: 10px;
        }
        
        .finish-btn {
            margin: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }
        
        .finish-btn:hover { transform: translateY(-1px); }
        
        #imageUpload { display: none; }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="toolbar">
            <div class="tool-group">
                <h3>Tools</h3>
                <button class="tool-btn" onclick="addRectangle()">Rectangle</button>
                <button class="tool-btn" onclick="addCircle()">Circle</button>
                <button class="tool-btn" onclick="addText()">Text</button>
                <button class="tool-btn" onclick="addLine()">Line</button>
                <button class="tool-btn" onclick="document.getElementById('imageUpload').click()">Image</button>
                <input type="file" id="imageUpload" accept="image/*">
            </div>
            
            <div class="tool-group">
                <h3>Properties</h3>
                <div class="property-row">
                    <span class="property-label">Fill</span>
                    <input type="color" id="fillColor" class="color-input" value="#3498db">
                </div>
                <div class="property-row">
                    <span class="property-label">Stroke</span>
                    <input type="color" id="strokeColor" class="color-input" value="#2c3e50">
                </div>
                <div class="property-row">
                    <span class="property-label">Width</span>
                    <input type="range" id="strokeWidth" class="range-input" min="0" max="20" value="2">
                    <span id="strokeWidthValue">2</span>
                </div>
                <div class="property-row">
                    <span class="property-label">Opacity</span>
                    <input type="range" id="opacity" class="range-input" min="0" max="100" value="100">
                    <span id="opacityValue">100</span>
                </div>
                <div class="property-row">
                    <span class="property-label">Radius</span>
                    <input type="range" id="cornerRadius" class="range-input" min="0" max="50" value="0">
                    <span id="cornerRadiusValue">0</span>
                </div>
            </div>
            
            <div class="tool-group">
                <h3>Text</h3>
                <input type="text" id="textContent" class="property-input" placeholder="Enter text..." value="Sample Text">
                <select id="fontFamily" class="property-input" style="margin-top: 8px;">
                    <option value="Arial">Arial</option>
                    <option value="Helvetica">Helvetica</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Impact">Impact</option>
                </select>
                <div class="property-row" style="margin-top: 8px;">
                    <span class="property-label">Size</span>
                    <input type="range" id="fontSize" class="range-input" min="12" max="120" value="24">
                    <span id="fontSizeValue">24</span>
                </div>
                <div class="property-row">
                    <span class="property-label">Weight</span>
                    <select id="fontWeight" class="property-input">
                        <option value="normal">Normal</option>
                        <option value="bold">Bold</option>
                    </select>
                </div>
            </div>
            
            <div class="tool-group">
                <h3>Actions</h3>
                <button class="tool-btn" onclick="duplicateSelected()">Duplicate</button>
                <button class="tool-btn" onclick="deleteSelected()">Delete</button>
                <button class="tool-btn" onclick="bringToFront()">Bring Front</button>
                <button class="tool-btn" onclick="sendToBack()">Send Back</button>
                <button class="tool-btn" onclick="clearCanvas()">Clear All</button>
            </div>
            
            <div class="layers-panel">
                <div class="tool-group">
                    <h3>Layers</h3>
                    <div id="layersList"></div>
                </div>
            </div>
            
            <button class="finish-btn" onclick="finishCover()">Finish Cover Design</button>
        </div>
        
        <div class="canvas-area">
            <div class="canvas-wrapper">
                <div id="container"></div>
            </div>
        </div>
    </div>
    
    <script>
        const { ipcRenderer } = require('electron');
        
        // Initialize Konva stage
        const stage = new Konva.Stage({
            container: 'container',
            width: 595,
            height: 842
        });
        
        const layer = new Konva.Layer();
        stage.add(layer);
        
        // Add white background
        const background = new Konva.Rect({
            x: 0,
            y: 0,
            width: 595,
            height: 842,
            fill: 'white'
        });
        layer.add(background);
        
        let selectedShape = null;
        let transformer = new Konva.Transformer({
            rotateAnchorOffset: 30,
            borderStroke: '#007acc',
            borderStrokeWidth: 2,
            anchorStroke: '#007acc',
            anchorFill: 'white',
            anchorSize: 8
        });
        layer.add(transformer);
        
        // Add Rectangle
        function addRectangle() {
            const rect = new Konva.Rect({
                x: 100,
                y: 100,
                width: 150,
                height: 100,
                fill: document.getElementById('fillColor').value,
                stroke: document.getElementById('strokeColor').value,
                strokeWidth: parseInt(document.getElementById('strokeWidth').value),
                opacity: parseInt(document.getElementById('opacity').value) / 100,
                cornerRadius: parseInt(document.getElementById('cornerRadius').value),
                draggable: true,
                name: 'shape'
            });
            
            setupShapeEvents(rect);
            layer.add(rect);
            selectShape(rect);
            updateLayers();
        }
        
        // Add Circle
        function addCircle() {
            const circle = new Konva.Circle({
                x: 200,
                y: 200,
                radius: 60,
                fill: document.getElementById('fillColor').value,
                stroke: document.getElementById('strokeColor').value,
                strokeWidth: parseInt(document.getElementById('strokeWidth').value),
                opacity: parseInt(document.getElementById('opacity').value) / 100,
                draggable: true,
                name: 'shape'
            });
            
            setupShapeEvents(circle);
            layer.add(circle);
            selectShape(circle);
            updateLayers();
        }
        
        // Add Text
        function addText() {
            const text = new Konva.Text({
                x: 100,
                y: 300,
                text: document.getElementById('textContent').value,
                fontSize: parseInt(document.getElementById('fontSize').value),
                fontFamily: document.getElementById('fontFamily').value,
                fontStyle: document.getElementById('fontWeight').value,
                fill: document.getElementById('fillColor').value,
                opacity: parseInt(document.getElementById('opacity').value) / 100,
                draggable: true,
                name: 'shape'
            });
            
            setupShapeEvents(text);
            layer.add(text);
            selectShape(text);
            updateLayers();
        }
        
        // Add Line
        function addLine() {
            const line = new Konva.Line({
                points: [100, 400, 300, 400],
                stroke: document.getElementById('strokeColor').value,
                strokeWidth: parseInt(document.getElementById('strokeWidth').value),
                opacity: parseInt(document.getElementById('opacity').value) / 100,
                draggable: true,
                name: 'shape'
            });
            
            setupShapeEvents(line);
            layer.add(line);
            selectShape(line);
            updateLayers();
        }
        
        // Image upload
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const imageObj = new Image();
                imageObj.onload = function() {
                    const image = new Konva.Image({
                        x: 100,
                        y: 100,
                        image: imageObj,
                        width: Math.min(imageObj.width, 200),
                        height: Math.min(imageObj.height, 200),
                        draggable: true,
                        name: 'shape'
                    });
                    
                    setupShapeEvents(image);
                    layer.add(image);
                    selectShape(image);
                    updateLayers();
                };
                imageObj.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
        
        // Setup shape events
        function setupShapeEvents(shape) {
            shape.on('click', () => selectShape(shape));
            shape.on('dragend', updateLayers);
        }
        
        // Select shape
        function selectShape(shape) {
            selectedShape = shape;
            transformer.nodes([shape]);
            updatePropertiesPanel();
            updateLayers();
        }
        
        // Deselect on background click
        background.on('click', () => {
            selectedShape = null;
            transformer.nodes([]);
            updateLayers();
        });
        
        // Update properties panel
        function updatePropertiesPanel() {
            if (!selectedShape) return;
            
            if (selectedShape.fill) document.getElementById('fillColor').value = selectedShape.fill();
            if (selectedShape.stroke) document.getElementById('strokeColor').value = selectedShape.stroke();
            if (selectedShape.strokeWidth) {
                document.getElementById('strokeWidth').value = selectedShape.strokeWidth();
                document.getElementById('strokeWidthValue').textContent = selectedShape.strokeWidth();
            }
            if (selectedShape.opacity) {
                const opacity = Math.round(selectedShape.opacity() * 100);
                document.getElementById('opacity').value = opacity;
                document.getElementById('opacityValue').textContent = opacity;
            }
            
            if (selectedShape.className === 'Text') {
                document.getElementById('textContent').value = selectedShape.text();
                document.getElementById('fontFamily').value = selectedShape.fontFamily();
                document.getElementById('fontSize').value = selectedShape.fontSize();
                document.getElementById('fontSizeValue').textContent = selectedShape.fontSize();
                document.getElementById('fontWeight').value = selectedShape.fontStyle();
            }
            
            if (selectedShape.cornerRadius) {
                document.getElementById('cornerRadius').value = selectedShape.cornerRadius();
                document.getElementById('cornerRadiusValue').textContent = selectedShape.cornerRadius();
            }
        }
        
        // Apply property changes
        function updateSelectedShape() {
            if (!selectedShape) return;
            
            const props = {
                opacity: parseInt(document.getElementById('opacity').value) / 100
            };
            
            if (selectedShape.fill) props.fill = document.getElementById('fillColor').value;
            if (selectedShape.stroke) {
                props.stroke = document.getElementById('strokeColor').value;
                props.strokeWidth = parseInt(document.getElementById('strokeWidth').value);
            }
            
            if (selectedShape.className === 'Text') {
                props.text = document.getElementById('textContent').value;
                props.fontFamily = document.getElementById('fontFamily').value;
                props.fontSize = parseInt(document.getElementById('fontSize').value);
                props.fontStyle = document.getElementById('fontWeight').value;
            }
            
            if (selectedShape.cornerRadius !== undefined) {
                props.cornerRadius = parseInt(document.getElementById('cornerRadius').value);
            }
            
            selectedShape.setAttrs(props);
            layer.batchDraw();
        }
        
        // Property change listeners
        ['fillColor', 'strokeColor', 'strokeWidth', 'opacity', 'cornerRadius', 'textContent', 'fontFamily', 'fontSize', 'fontWeight'].forEach(id => {
            document.getElementById(id).addEventListener('input', function(e) {
                if (id === 'strokeWidth') document.getElementById('strokeWidthValue').textContent = e.target.value;
                if (id === 'opacity') document.getElementById('opacityValue').textContent = e.target.value;
                if (id === 'cornerRadius') document.getElementById('cornerRadiusValue').textContent = e.target.value;
                if (id === 'fontSize') document.getElementById('fontSizeValue').textContent = e.target.value;
                updateSelectedShape();
            });
        });
        
        // Actions
        function duplicateSelected() {
            if (!selectedShape) return;
            const clone = selectedShape.clone();
            clone.x(clone.x() + 20);
            clone.y(clone.y() + 20);
            setupShapeEvents(clone);
            layer.add(clone);
            selectShape(clone);
            updateLayers();
        }
        
        function deleteSelected() {
            if (!selectedShape) return;
            selectedShape.destroy();
            selectedShape = null;
            transformer.nodes([]);
            updateLayers();
        }
        
        function bringToFront() {
            if (!selectedShape) return;
            selectedShape.moveToTop();
            transformer.moveToTop();
            layer.batchDraw();
            updateLayers();
        }
        
        function sendToBack() {
            if (!selectedShape) return;
            selectedShape.moveToBottom();
            background.moveToBottom();
            layer.batchDraw();
            updateLayers();
        }
        
        function clearCanvas() {
            layer.destroyChildren();
            layer.add(background);
            layer.add(transformer);
            selectedShape = null;
            transformer.nodes([]);
            updateLayers();
        }
        
        // Update layers panel
        function updateLayers() {
            const layersList = document.getElementById('layersList');
            layersList.innerHTML = '';
            
            const shapes = layer.children.filter(child => child.name() === 'shape');
            shapes.reverse().forEach((shape, index) => {
                const layerItem = document.createElement('div');
                layerItem.className = 'layer-item';
                if (shape === selectedShape) layerItem.classList.add('selected');
                
                const name = shape.className || 'Shape';
                layerItem.innerHTML = `
                    <span>${name} ${shapes.length - index}</span>
                    <div class="layer-controls">
                        <button class="layer-btn" onclick="toggleVisibility('${shape._id}')">👁</button>
                        <button class="layer-btn" onclick="deleteLayer('${shape._id}')">🗑</button>
                    </div>
                `;
                
                layerItem.onclick = (e) => {
                    if (e.target.classList.contains('layer-btn')) return;
                    selectShape(shape);
                };
                
                layersList.appendChild(layerItem);
            });
            
            layer.batchDraw();
        }
        
        function toggleVisibility(shapeId) {
            const shape = layer.findOne(`#${shapeId}`);
            if (shape) {
                shape.visible(!shape.visible());
                layer.batchDraw();
            }
        }
        
        function deleteLayer(shapeId) {
            const shape = layer.findOne(`#${shapeId}`);
            if (shape) {
                if (shape === selectedShape) {
                    selectedShape = null;
                    transformer.nodes([]);
                }
                shape.destroy();
                updateLayers();
            }
        }
        
        // Finish cover design
        async function finishCover() {
            transformer.nodes([]);
            layer.batchDraw();
            
            const dataURL = stage.toDataURL({ pixelRatio: 2 });
            
            try {
                const result = await ipcRenderer.invoke('add-cover-to-pdf', dataURL);
                if (result.success) {
                    window.location.href = 'final-viewer.html';
                } else {
                    alert('Error creating final PDF: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // Initialize with sample text
        setTimeout(() => {
            addText();
            selectedShape.setAttrs({
                text: 'My Word Search Book',
                fontSize: 36,
                x: 150,
                y: 200,
                fontStyle: 'bold'
            });
            layer.batchDraw();
            updateLayers();
        }, 100);
        
        layer.batchDraw();
    </script>
</body>
</html>